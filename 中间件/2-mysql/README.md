### Mysql

mysql由server层和存储引擎组成

server层包括：连接器（管理链接、权限校验）、查询缓存、分析器（词法分析、语法分析）、优化器（执行计划生成，索引选择）、执行器（操作引擎返回结果）

DDL：Data Definition Language数据定于语言，即对表结构的修改操作

DML：Data Manipulation Language数据操控语言，即对表数据的修改

#### 索引

##### 索引数据结构

> mysql使用B+树

使用索引比较：

hash：一半用于等值查询

###### B树

每个节点存储关键字数组、指针数组（指向儿子）、数据

###### B+树

非叶子结点不存储data，叶子结点不存储指针

每个叶子结点增加指向相邻叶子结点的指针

##### 聚簇索引

一种数据存储方式。InnoDB主键使用聚簇索引：叶子结点上的data保存的是对应行的全部数据

优点：访问速度快，只要找到索引，立即能获取到数据

##### 非聚簇索引

也叫二次索引，保存的是主键的值

优点：减少IO次数

但是可能需要回表：即先查询到主键再查主键对应的数据

##### 索引查询优化

1、最左前缀匹配原则

> mysql索引是排序好的，一直向右匹配直到遇到范围查询(><between、like)
>
> 例：(a,b,c,d)索引使用a = 1 and b = 2 and c > 3 and d = 4查询只使用了abc索引

2、索引下推

> Mysql5.6添加，可以对索引上的字段进行过滤(只过滤=)

3、覆盖索引

> 查询的数据在索引树上能查询到，不需要回表。比如联合索引

#### 锁

表级锁、行级锁

行锁实现：InnoDB通过给索引上的索引项加锁实现的

MDL锁（metadata lock）：保证DDL和DML操作的一致性

#### MVCC（多版本并发控制）

InnoDB实现隔离级别的一种实现。用来实现提交读和可重复读

更新的数据的时候回记录一条回滚操作，当没有事务再需要这个read-view时删除

###### 可重复读事务隔离实现方式

> 每个事务会创建read-view，每行数据有多个版本

> 获取表中当前数据，再回滚事务期间的视图（使用undo log回滚），得到事务启动时的值

> 开启可重复读事务时，创建活跃事务数组和当前事务最大值+1(高水位)，低水位即是数组最小值。回滚时根据事务id和数组里的事务回滚得到值

MVCC读取的是快照读

当前读：更新时先读后写(select for update 或者select in share mode)

#### 事务

- 读未提交：事务没提交做的变更也能被看到
- 读提交：事务提交后，做的变更才能被看到
- 可重复读：事务执行过程中，看到的数据和事务启动前一致。即别的事务修改的数据看不到
- 串行化：写加写锁、读加读锁

##### 脏读

事务A对数据进行了修改，没有提交，事务B能查询到未提交的事务数据，并对数据进行了操作，如果A回滚，会导致数据不一致

##### 不可重读

事务A查询到数据后，其他事务修改后提交，事务A再次查询发现不一致

##### 幻读

事务在2个时刻读取范围的数据不一致(新插入了数据)。幻读需要是当前读，因为可重复读不会读其他事务的修改
